# Copilot Instructions — MapQC 3D (Detailed)

This repository contains BOTH browser and Node.js code.
Copilot must respect runtime boundaries.

====================================================
GLOBAL RULES
====================================================

• Strict TypeScript (no implicit any)
• No global mutable state
• All shared logic must live in packages/shared
• QA functions must be pure
• Deterministic outputs only
• Avoid side effects outside orchestrator layer

====================================================
WEB APP RULES (apps/web)
====================================================

Runtime:
• Browser only
• No fs/path/process usage
• No Node-only imports

three.js lifecycle:
• Renderer created once in ThreeApp
• Scene modules implement init/update/dispose
• All geometries/materials/textures must be disposed
• No per-frame allocations
• Cap pixel ratio at 2

State:
• React owns UI state
• three.js never mutates React state
• No logic inside render loop except rendering

GeoTIFF:
• Use geotiff.js
• Compute extent deterministically
• Do not assume CRS reprojection unless enabled

====================================================
CLI RULES (apps/cli)
====================================================

Runtime:
• Node.js 18+ only

Architecture:
• RunContext object must manage:
  - runId
  - config
  - logger
  - timing
• Orchestrator must continue-on-error
• Each file processed independently
• Errors captured, not thrown globally

Logging:
• Structured JSON logging default
• Human-readable optional

Reports:
• JSON report must include:
  - file id
  - derived extent
  - pixel size
  - QA results
  - timestamps

====================================================
SHARED PACKAGE RULES (packages/shared)
====================================================

• No environment-specific code
• No DOM
• No filesystem
• No three.js
• No CLI parsing

Only:
• Types
• Domain models
• QA checks
• Report schema builders

====================================================
CODE GENERATION REQUIREMENTS
====================================================

When generating code:
• Provide complete files unless asked otherwise
• Include error handling
• Avoid over-engineering
• Keep functions small
• Comment public APIs
• No clever abstractions

====================================================
AI AGENT ALIGNMENT
====================================================

When using agents in ai-dev:
• Follow subagent boundaries
• Do not mix responsibilities
• Keep orchestration separate from processing
• Keep integration separate from domain logic

====================================================
DISALLOWED PATTERNS
====================================================

• Mixing web + Node APIs
• Putting QA logic in UI components
• Creating singletons
• Adding global event emitters
• Swallowing errors silently
• Creating three.js objects without disposal

====================================================
END OF INSTRUCTIONS
====================================================
